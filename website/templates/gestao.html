{% extends "base.html" %}
{% block title %}Gestão – Cutelaria{% endblock %}

{% block content %}
<h2>Painel de Gestão</h2>

<ul class="nav nav-tabs" id="gestaoTabs" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="mp-tab" data-toggle="tab" href="#mp" role="tab">Matéria-Prima</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="pa-tab" data-toggle="tab" href="#pa" role="tab">Produtos Acabados</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="pv-tab" data-toggle="tab" href="#pv" role="tab">Pedidos / Vendas</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="os-tab" data-toggle="tab" href="#os" role="tab">Ordem de Serviço</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="alertas-tab" data-toggle="tab" href="#alertas" role="tab">Alertas & Indicadores</a>
  </li>
</ul>

<div class="tab-content mt-3">
  <!-- MATÉRIA-PRIMA -->
  <div class="tab-pane fade show active" id="mp" role="tabpanel">
    <a href="{{ url_for('views.nova_materia_prima') }}"
       class="btn btn-sm btn-success mb-2">
      + Matéria-Prima
    </a>
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th>Código</th><th>Tipo</th><th>Unidade</th><th>Qtd. Estoque</th>
          <th>Ponto Rep.</th><th>Fornecedor</th><th>Últ. Entrada</th><th>Obs</th>
        </tr>
      </thead>
      <tbody>
        {% for m in materias %}
        <tr>
          <td>{{ m.codigo_item }}</td>
          <td>{{ m.tipo_material }}</td>
          <td>{{ m.unidade }}</td>
          <td>{{ m.quantidade_estoque }}</td>
          <td>{{ m.ponto_reposicao }}</td>
          <td>{{ m.fornecedor or '-' }}</td>
          <td>{{ m.data_ultima_entrada.strftime('%d/%m/%Y') }}</td>
          <td>{{ m.observacoes or '-' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- PRODUTOS ACABADOS -->
  <div class="tab-pane fade" id="pa" role="tabpanel">
    <a href="{{ url_for('views.novo_produto_acabado') }}"
       class="btn btn-sm btn-success mb-2">
      + Produto Acabado
    </a>
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th>Código</th><th>Tipo</th><th>Lâmina</th><th>Cabo</th>
          <th>Disp.</th><th>Reser.</th><th>Vend. Mês</th><th>Obs</th>
        </tr>
      </thead>
      <tbody>
        {% for p in produtos %}
        <tr>
          <td>{{ p.codigo_faca }}</td>
          <td>{{ p.tipo }}</td>
          <td>{{ p.material_lamina }}</td>
          <td>{{ p.material_cabo }}</td>
          <td>{{ p.quantidade_disponivel }}</td>
          <td>{{ p.quantidade_reservada }}</td>
          <td>{{ p.quantidade_vendida_mes }}</td>
          <td>{{ p.observacoes or '-' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- PEDIDOS / VENDAS -->
  <div class="tab-pane fade" id="pv" role="tabpanel">
    <a href="{{ url_for('views.novo_pedido_venda') }}"
       class="btn btn-sm btn-success mb-2">
      + Pedido / Venda
    </a>
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th>Nº Pedido</th><th>Cliente</th><th>Produtos</th><th>Pers.</th>
          <th>Data Pedido</th><th>Status</th><th>Entrega Prev.</th>
          <th>Valor</th><th>Obs</th>
        </tr>
      </thead>
      <tbody>
        {% for v in pedidos %}
        <tr>
          <td>{{ v.numero_pedido }}</td>
          <td>{{ v.nome_cliente }}</td>
          <td>{{ v.produtos_solicitados }}</td>
          <td>{{ 'Sim' if v.personalizacao else 'Não' }}</td>
          <td>{{ v.data_pedido.strftime('%d/%m/%Y') }}</td>
          <td>{{ v.status }}</td>
          <td>{{ v.data_prevista_entrega.strftime('%d/%m/%Y') if v.data_prevista_entrega else '-' }}</td>
          <td>R$ {{ "%.2f"|format(v.valor_pedido) }}</td>
          <td>{{ v.observacoes or '-' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ORDEM DE SERVIÇO -->
  <div class="tab-pane fade" id="os" role="tabpanel">
    <a href="{{ url_for('views.nova_ordem_servico') }}"
       class="btn btn-sm btn-success mb-2">
      + Ordem de Serviço
    </a>
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th>Nº OS</th><th>Produto</th><th>Qtd</th><th>Mat. Necessários</th>
          <th>Início</th><th>Prev. Conclusão</th><th>Resp.</th><th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for o in ordens %}
        <tr>
          <td>{{ o.numero_os }}</td>
          <td>{{ o.produto.codigo_faca }}</td>
          <td>{{ o.quantidade }}</td>
          <td>{{ o.materiais_necessarios }}</td>
          <td>{{ o.data_inicio_producao.strftime('%d/%m/%Y') }}</td>
          <td>{{ o.data_prevista_conclusao.strftime('%d/%m/%Y') if o.data_prevista_conclusao else '-' }}</td>
          <td>{{ o.responsavel }}</td>
          <td>{{ o.status }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ALERTAS & INDICADORES -->
  <div class="tab-pane fade" id="alertas" role="tabpanel">
    <h4>Alertas e Indicadores</h4>
    <ul>
      <li>Itens abaixo do mínimo: <strong>{{ itens_baixo_estoque|length }}</strong></li>
      <li>Pedidos vencidos: <strong>{{ pedidos_vencidos|length }}</strong></li>
      <li>Produções em atraso: <strong>{{ producoes_atrasadas|length }}</strong></li>
      <li>Total de pedidos em andamento: <strong>{{ total_pedidos_andamento }}</strong></li>
      <li>Vendas do mês (R$): <strong>{{ "%.2f"|format(vendas_mes) }}</strong></li>
    </ul>
  </div>
</div>

<script>
  $('#gestaoTabs a').on('click', function (e) {
    e.preventDefault();
    $(this).tab('show');
  });
</script>
{% endblock %}
